version: "3.8"

services:
  backend:
    build:
      context: ./backend/server
      dockerfile: Dockerfile.server
    container_name: backend
    environment:
      AI_SERVICE_URL: http://ai-service:5000
      DATABASE_URL: postgres://user:password@db:5432/db
    depends_on:
      #- ai-service
      - db
    ports:
      - "8081:8081"
    networks: [app-network]

  # ai-service:
  #   build:
  #     context: ./backend/ai
  #     dockerfile: Dockerfile.ai-service
  #   container_name: ai-service
  #   environment:
  #     CHROMA_URL: http://chroma:8000
  #     OLLAMA_URL: http://ollama:11434
  #     CHAT_MODEL: phi3:mini
  #     EMBEDDING_BACKEND: ollama
  #   depends_on:
  #     - chroma
  #     - ollama
  #   volumes:
  #     - ./backend/ai:/app
  #   ports:
  #     - "5000:5000"
  #   networks: [app-network]

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.client
      target: dev
    container_name: frontend
    depends_on:
      - backend
    ports:
      - "8082:8082"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks: [app-network]

  db:
    image: postgres:14
    container_name: db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks: [app-network]

# chroma:
#   image: chromadb/chroma:latest
#   environment:
#     CHROMA_SERVER_HOST: 0.0.0.0
#     CHROMA_SERVER_HTTP_PORT: 8000
#   container_name: chroma
#   volumes:
#     - chroma_data:/chroma
#   ports:
#     - "8000:8000"
#   networks: [app-network]

# ollama:
#   image: ollama/ollama:latest
#   volumes:
#     - ollama_models:/root/.ollama
#   container_name: ollama
#   ports:
#     - "11434:11434"
#   networks: [app-network]
#   entrypoint:
#     [
#       "/bin/sh",
#       "-c",
#       "ollama serve & sleep 3 && ollama pull phi3:mini && tail -f /dev/null",
#     ]

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  #chroma_data:
  #ollama_models:
